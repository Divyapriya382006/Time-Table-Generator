<!--this is not my code,this is from chatgpt-->
<html>
<head>
  <title>Time Table Generator</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="style.css">
  <style>
    /* Optional: Add some basic styling for better visualization of paired slots */
    .slot-group-container {
      border: 1px solid #e0e0e0;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #fcfcfc;
      border-radius: 5px;
    }
    .slot-group-container select {
      margin-right: 5px;
    }
    .slot-group-container label {
      font-weight: bold;
      margin-right: 5px;
    }
    /* Adjusted for faculty-slot-lab inline layout */
    .subject-input-group {
        display: flex;
        flex-wrap: wrap; /* Allow wrapping for smaller screens */
        align-items: center; /* Vertically align items */
        margin-bottom: 10px;
    }
    .subject-input-group label {
        margin-right: 5px;
        flex-shrink: 0; /* Prevent label from shrinking */
    }
    .subject-input-group select,
    .subject-input-group input {
        margin-right: 10px; /* Spacing between elements */
        margin-bottom: 5px; /* For wrapping elements */
    }
    .slot-choice-line {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        margin-bottom: 10px; /* Space between multiple slot choices */
        border: 1px dashed #e6e6e6; /* Border for each choice group */
        padding: 8px;
        border-radius: 4px;
        background-color: #f9f9f9;
    }
    .slot-choice-line label,
    .slot-choice-line select {
        margin-right: 8px;
        margin-bottom: 4px;
    }
    .slot-choice-line .lab-select-group {
        display: flex;
        flex-direction: column; /* Stack lab dropdowns if multiple */
        margin-left: 15px; /* Space between core slots and lab slots */
        padding-left: 15px;
        border-left: 1px solid #eee;
    }
    .slot-choice-line .lab-select-group select {
        margin-bottom: 5px;
    }

  </style>
</head>
<body>

<h1><b>Time Table Generator</b></h1>
<form id="ttform">
  <p>How many Subjects do you have?</p>
  <input type="number" min="1" id="subcount" required>
  <button type="button" onclick="generateInputs()">Next</button>
  <div id="subjectInputs"></div>
  <button type="submit">Generate Timetables</button>
</form>

<div id="output"></div>
<div id="visualOutput"></div>

<script>
const subjectsList = ["CVLA", "MPMC", "JAVA", "STS", "FL", "DSA", "CAO", "OS", "French"];

const facultyMap = {
  JAVA: ["Anusooya","Senthil","Rajesh","Sivakumar","Jahangeer","Jenila","Rajiv","Pradeep","Kanniga","Sivakami","Saravana","Marimuthu","Jai Vinitha","Tahir"],
  DSA: ["Kartika","Abishi","Rishi","Bhuvaneshvari","Uma","Rolla","Joe","Mary","Raja Shree","Pravin","Sendhil","Senthil Kumar","Rajakumar","Uma"],
  CAO: ["Padma","Manjula","Kaja","Aswiga","Revathi","Linda","Thani","Sree Prakash"],
  OS: ["Kumar","Anita","Indra","Vatchala","Shyamala","Rabindra","Yogesh","Anandan","Saranya"],
  CVLA: ["ABHISHEK KUMAR SING","NATHIYA N","SAROJ KUMAR DASH","SANDIP KUMAR DAS","SETHUKUMARASAMY","MANIMARAN J","OM NAMHA SHIVAY","SUDIP DEBNATH","ASHIS BERA","SRUTHA KEERTHI B","MANIVANNAN A","VIJAY KUMAR P","DHIVYA M","RAJESH KUMAR MOHAPATR","SOWNDARRAJAN P T","PADMAJA N","DURGAPRASAD P","HARSHAVARTHINI","BALAJI","JAYAGOPAL R","MOHIT KUMAR","DURGA"],
  French: ["GOVINDARAJAN P","CLARISSE ROUABAH","THANI THAMIZHARASI","NEWFACULTY"],
  MPMC: ["ABRAHAM SUDHARSON J","AMIT KUMAR","BALAKRISHNAN R","BERLIN HENCY V","CHANTHINI BASKAR","CHITRA K","DANUSH R","E MANIKANDAN","GUGA PRIYA G","HARIHARAN","IDAYACHANDRAN G","JAGANNATH M","JOHN SAHAYA RANI ALEX","KARTHIKEYAN P R","KIRAN KUMAR M","MOHAMMED AARIF K O","MUTHULAKSHMI S","RAVI TIWARI","REVATHI S","RICHARDS JOE STANISLAUS","SARAVANA KUMAR R","SINDHUJA M","SOURABH PAUL","S SELVENDRAN","SRIDHAR C","SUBHASHINI N","SUHASINI S","SIVASUBRAMANIAN A","VIGNESWARAN T","V R BALAJI","VYDEKI D","MANOJ KUMAR R","SUDHARSON J"]
};

// Define the linked slot trios for CVLA
const cvlaSlotTrios = {
    "C1": ["TC1", "TCC1"],
    "C2": ["TC2", "TCC2"],
    "A1": ["TA1", "TAA1"],
    "A2": ["TA2", "TAA2"]
};

// Map CVLA faculty to the primary slots they teach
const cvlaFacultySlotMapping = {
    "ABHISHEK KUMAR SING": ["C1", "A2"],
    "NATHIYA N": ["C1", "A2"],
    "SAROJ KUMAR DASH": ["C1", "C2"],
    "SANDIP KUMAR DAS": ["C1"],
    "SETHUKUMARASAMY": ["C1", "C2"],
    "MANIMARAN J": ["C1", "C2"],
    "OM NAMHA SHIVAY": ["C1", "A2"],
    "SUDIP DEBNATH": ["C1", "C2"],
    "ASHIS BERA": ["C2"],
    "SRUTHA KEERTHI B": ["A1"],
    "MANIVANNAN A": ["A1"],
    "VIJAY KUMAR P": ["A1", "A2"],
    "DHIVYA M": ["A1", "A2"],
    "RAJESH KUMAR MOHAPATR": ["A1"],
    "SOWNDARRAJAN P T": ["A1", "A2"],
    "PADMAJA N": ["A1"],
    "DURGAPRASAD P": ["A2"],
    "HARSHAVARTHINI": ["A2"],
    "BALAJI": ["A1", "A2"],
    "JAYAGOPAL R": ["A1", "A2"],
    "MOHIT KUMAR": ["A2"],
    "DURGA": ["A2"]
};


// Define paired slots for DSA, CAO, OS, MPMC core slots
const subjectPairedSlotInfo = {
    DSA: {
        primaryOptions: ["C1", "C2", "TCC1", "TCC2"], // These are the theoretical full options
        pairings: { "C1": "TC1", "C2": "TC2" }
    },
    CAO: {
        primaryOptions: ["D1", "D2", "TDD1", "TDD2"],
        pairings: { "D1": "TD1", "D2": "TD2" }
    },
    OS: {
        primaryOptions: ["E1", "E2"],
        pairings: { "E1": "TE1", "E2": "TE2" }
    },
    MPMC: {
        primaryOptions: ["A1", "D1", "G1", "A2", "D2", "G2"],
        pairings: {
            "A1": "TA1", "D1": "TD1", "G1": "TG1",
            "A2": "TA2", "D2": "TD2", "G2": "TG2"
        }
    }
};

// Generate all consecutive lab slot pairs from L1+L2 to L59+L60
const allLabPairs = [];
for (let i = 1; i <= 59; i += 2) {
    allLabPairs.push(`L${i}+L${i+1}`);
}

// Define lab slot configurations for subjects that have them
const subjectLabConfig = {
    JAVA: { numDropdowns: 2, options: allLabPairs },
    MPMC: { numDropdowns: 1, options: allLabPairs },
    DSA:  { numDropdowns: 1, options: allLabPairs },
    OS:   { numDropdowns: 1, options: allLabPairs }
};

// NEW: Detailed Faculty-CoreSlot-LabSlot Mapping
const subjectFacultySlotLabMapping = {
    "JAVA": {
        "Anusooya": { "TB1": ["L29+L30", "L31+L32"] },
        "Senthil": { "TB1": ["L39+L40", "L51+L52"], "TB2": ["L1+L2", "L19+L20"] },
        "Rajesh": { "TB1": ["L37+L38", "L55+L56"], "TB2": ["L15+L16", "L27+L28"] },
        "Sivakumar": { "TB1": ["L31+L32", "L49+L50"], "TB2": ["L47+L48", "L53+L54"] },
        "Jahangeer": { "TB1": ["L31+L32", "L49+L50"], "TB2": ["L47+L48", "L53+L54"] },
        "Jenila": { "TB1": ["L29+L30", "L43+L44"] },
        "Rajiv": { "TB2": ["L9+L10", "L21+L22"] },
        "Pradeep": { "TB2": ["L3+L4", "L13+L14"] },
        "Kanniga": { "TB1": ["L31+L32", "L49+L50"], "TB2": ["L15+L16", "L27+L28"] },
        "Sivakami": { "TB1": ["L39+L40", "L51+L52"], "TB2": ["L9+L10", "L21+L22"] },
        "Saravana": { "TB1": ["L39+L40", "L51+L52"], "TB2": ["L1+L2", "L19+L20"] },
        "Marimuthu": { "TB1": ["L23+L24", "L29+L30"], "TB2": ["L7+L8", "L25+L26"] },
        "Tahir": { "TB2": ["L7+L8", "L25+L26"] }
    },
    "DSA": {
        "Kartika": { "C1+TC1": ["L37+L38"], "C2+TC2": ["L5+L6"] },
        "Abishi": { "C1+TC1": ["L51+L52"], "C2+TC2": ["L21+L22"] },
        "Rishi": { "C1+TC1": ["L45+L46"], "C2+TC2": ["L3+L4"] },
        "Bhuvaneshvari": { "C1+TC1": ["L33+L34"], "C2+TC2": ["L19+L20"] },
        "Uma": { "C1+TC1": ["L33+L34", "L1+L2"] },
        "Rolla": { "C1+TC1": ["L19+L20"] },
        "Joe": { "C1+TC1": ["L57+L58"] },
        "Mary": { "C1+TC1": ["L49+L50"], "C2+TC2": ["L19+L20"] },
        "Raja Shree": { "C1+TC1": ["L51+L52"], "C2+TC2": ["L7+L8"] },
        "Pravin": { "C1+TC1": ["L45+L46"], "C2+TC2": ["L5+L6"] },
        "Sendhil": { "C1+TC1": ["L31+L32"], "C2+TC2": ["L3+L4"] },
        "Senthil Kumar": { "C2+TC2": ["L27+L28"] },
        "Rajakumar": { "C1+TC1": ["L1+L2"] }
    },
    "CAO": {
        // No specific lab slots tied to theory slots in the image.
        // Lab dropdowns will show allLabPairs if no specific map found.
        "Padma": { "D1+TD1": [], "D2+TD2": [] },
        "Manjula": { "D1+TD1": [] },
        "Kaja": { "D1+TD1": [], "D2+TD2": [] },
        "Aswiga": { "D1+TD1": [], "D2+TD2": [] },
        "Revathi": { "D1+TD1": [], "D2+TD2": [] },
        "Linda": { "D2+TD2": [] },
        "Thani": { "D2+TD2": [] },
        "Sree Prakash": { "D2+TD2": [] }
    },
    "OS": {
        "Kumar": { "E1+TE1": ["L29+L30"] },
        "Anita": { "E1+TE1": ["L45+L46"], "E2+TE2": ["L27+L28"] },
        "Indra": { "E1+TE1": ["L45+L46"], "E2+TE2": ["L27+L28"] },
        "Vatchala": { "E1+TE1": ["L31+L32"], "E2+TE2": ["L3+L4"] },
        "Shyamala": { "E1+TE1": ["L39+L40"] },
        "Rabindra": { "E2+TE2": ["L23+L24"] },
        "Yogesh": { "E2+TE2": ["L9+L10"] },
        "Anandan": { "E2+TE2": ["L27+L28"] },
        "Saranya": { "E2+TE2": ["L25+L26"] }
    }
};


// This map is for subjects that *don't* have special pairing/trio logic OR lab slots
// and use standard single slot dropdowns.
const subjectSpecificSlots = {
    JAVA: ["TB1", "TB2"], // Regular core slots for Java, as single choices - now filtered by faculty
    FL: ["G1", "G2", "B1", "B2"],
    // STS will use allSlots() as no specific entry here
    // French will use allSlots() as no specific entry here
};


function allSlots() {
  let slots = [
    "A1", "B1", "C1", "D1", "E1", "F1", "G1", "TA1", "TB1", "TC1", "TD1", "TE1", "TF1", "TG1",
    "A2", "B2", "C2", "D2", "E2", "F2", "G2", "TA2", "TB2", "TC2", "TD2", "TE2", "TF2", "TG2",
    "TAA1", "TBB1", "TCC1", "TDD1", "TAA2", "TBB2", "TCC2", "TDD2"
  ];
  // Add all individual L slots from 1 to 60 to the general pool
  for (let i = 1; i <= 60; i++) {
    slots.push(`L${i}`);
  }
  return slots;
}

function generateInputs() {
  const count = parseInt(document.getElementById("subcount").value);
  const container = document.getElementById("subjectInputs");
  container.innerHTML = '';

  for (let i = 0; i < count; i++) {
    const div = document.createElement("div");
    div.innerHTML = `
      <div class="subject-input-group">
        <label>Subject ${i + 1}:</label>
        <select name="subject${i}" id="subject${i}" required onchange="generateSlotChoices(${i});">
          <option value="">--Select--</option>
          ${subjectsList.map(s => `<option value="${s}">${s}</option>`).join('')}
        </select>
        <label>Number of Slot Choices:</label>
        <input type="number" name="slotCount${i}" id="slotCount${i}" min="1" max="50" value="1" onchange="generateSlotChoices(${i})">
      </div>
      <div id="slotChoices${i}"></div>
      <hr>
    `;
    container.appendChild(div);
    // Initial call to generate slot choices based on default subject or previously selected one
    generateSlotChoices(i);
  }
}

function generateSlotChoices(index) {
  const count = parseInt(document.getElementById(`slotCount${index}`).value);
  const slotDiv = document.getElementById(`slotChoices${index}`);
  slotDiv.innerHTML = '';

  const selectedSubject = document.getElementById(`subject${index}`).value;
  const facultyList = facultyMap[selectedSubject] || [];

  for (let j = 0; j < count; j++) {
      const slotChoiceLine = document.createElement("div");
      slotChoiceLine.className = "slot-choice-line";

      // --- Faculty Dropdown (Always first now) ---
      const facultySelect = document.createElement("select");
      facultySelect.name = `faculty${index}_${j}`;
      facultySelect.id = `faculty${index}_${j}`;
      facultySelect.required = true;
      facultySelect.innerHTML = '<option value="">--Select Faculty--</option>' + facultyList.map(f => `<option value="${f}">${f}</option>`).join('');
      slotChoiceLine.appendChild(document.createTextNode('Faculty: '));
      slotChoiceLine.appendChild(facultySelect);

      // --- Core Slot(s) ---
      let primarySlotSelect; // Reference to the primary slot dropdown

      if (selectedSubject === "CVLA") {
          const primarySlotId = `slots${index}_${j}_0`;
          const secondarySlotId = `slots${index}_${j}_1`;
          const tertiarySlotId = `slots${index}_${j}_2`;

          primarySlotSelect = document.createElement("select");
          primarySlotSelect.name = primarySlotId;
          primarySlotSelect.id = primarySlotId;
          primarySlotSelect.required = true;
          primarySlotSelect.onchange = () => populateCVLATrio(index, j, primarySlotSelect.value);
          primarySlotSelect.innerHTML = '<option value="">--Select Primary--</option>'; // Initial empty

          const secondarySelect = document.createElement("select");
          secondarySelect.name = secondarySlotId;
          secondarySelect.id = secondarySlotId;
          secondarySelect.required = true;
          secondarySelect.disabled = true;
          secondarySelect.innerHTML = '<option value="">--Secondary--</option>';

          const tertiarySelect = document.createElement("select");
          tertiarySelect.name = tertiarySlotId;
          tertiarySelect.id = tertiarySlotId;
          tertiarySelect.required = true;
          tertiarySelect.disabled = true;
          tertiarySelect.innerHTML = '<option value="">--Tertiary--</option>';

          slotChoiceLine.appendChild(document.createTextNode(` Trio Choice ${j + 1}: `));
          slotChoiceLine.appendChild(primarySlotSelect);
          slotChoiceLine.appendChild(secondarySelect);
          slotChoiceLine.appendChild(tertiarySelect);

          // CVLA specific: Faculty change filters primary slot options
          facultySelect.onchange = () => updateCVLASlotsByFaculty(index, j, facultySelect.value);

      } else if (subjectPairedSlotInfo[selectedSubject]) {
          const primarySelectId = `slots${index}_${j}_primary`;
          const secondarySelectId = `slots${index}_${j}_secondary`;

          primarySlotSelect = document.createElement("select");
          primarySelect.name = primarySelectId;
          primarySelect.id = primarySelectId;
          primarySelect.required = true;
          // Note: The onchange for paired slot population is handled here.
          // The onchange for lab filtering will be added after this block if the subject has labs.
          primarySelect.onchange = () => populatePairedSlot(index, j, primarySelect.value, selectedSubject);
          primarySelect.innerHTML = '<option value="">--Select Primary--</option>'; // Initial empty


          const secondarySelect = document.createElement("select");
          secondarySelect.name = secondarySelectId;
          secondarySelect.id = secondarySelectId;
          secondarySelect.disabled = true;
          secondarySelect.innerHTML = '<option value="">--Paired Slot--</option>';

          slotChoiceLine.appendChild(document.createTextNode(` Slot Choice ${j + 1}: `));
          slotChoiceLine.appendChild(primarySlotSelect);
          slotChoiceLine.appendChild(secondarySelect);

          // For subjects with paired slots (DSA, CAO, OS, MPMC) and lab mappings:
          if (subjectFacultySlotLabMapping[selectedSubject]) {
              facultySelect.onchange = () => filterCoreSlotsAndLabsByFaculty(index, j, selectedSubject, facultySelect.value);
              primarySlotSelect.onchange = () => { // Extend existing onchange to also filter labs
                  populatePairedSlot(index, j, primarySelect.value, selectedSubject);
                  const coreSlotForLabFiltering = primarySelect.value;
                  const currentFaculty = facultySelect.value;
                  filterLabSlotsByCoreSlot(index, j, selectedSubject, currentFaculty, coreSlotForLabFiltering);
              };
          }

      } else { // STS, FL, French (and potentially others without specific pairing/trio logic)
          primarySlotSelect = document.createElement("select"); // Renamed for consistent handling
          primarySlotSelect.name = `slots${index}_${j}`;
          primarySlotSelect.required = true;
          primarySlotSelect.innerHTML = '<option value="">--Select Slot--</option>' + (subjectSpecificSlots[selectedSubject] || allSlots()).map(s => `<option value="${s}">${s}</option>`).join('');

          slotChoiceLine.appendChild(document.createTextNode(` Slot Choice ${j + 1}: `));
          slotChoiceLine.appendChild(primarySlotSelect);

          // For generic subjects that might have labs but no specific core slot filtering from faculty
          if (subjectLabConfig[selectedSubject] && subjectFacultySlotLabMapping[selectedSubject]) {
              facultySelect.onchange = () => {
                  // If no core slot filtering, labs are not filtered by core slot, only by faculty if mapped.
                  // For now, if no core slot mapping from faculty, just make labs available from allLabPairs.
                  filterLabSlotsByCoreSlot(index, j, selectedSubject, facultySelect.value, primarySlotSelect.value);
              };
              primarySlotSelect.onchange = () => {
                filterLabSlotsByCoreSlot(index, j, selectedSubject, facultySelect.value, primarySlotSelect.value);
              };
          }
      }

      // --- Lab Slot(s) (Inline with the current slot choice) ---
      if (subjectLabConfig[selectedSubject]) {
          const labConfig = subjectLabConfig[selectedSubject];
          const labSelectGroup = document.createElement("div");
          labSelectGroup.className = "lab-select-group";
          labSelectGroup.appendChild(document.createTextNode('Lab: '));

          for (let k = 0; k < labConfig.numDropdowns; k++) {
              const labDropdown = document.createElement("select");
              labDropdown.name = `labSlot${index}_${j}_${k}`; // Unique name per slot choice per dropdown
              labDropdown.id = `labSlot${index}_${j}_${k}`;
              labDropdown.required = true;
              labDropdown.disabled = true; // Initially disabled

              labDropdown.innerHTML = '<option value="">--Select Lab--</option>';
              labSelectGroup.appendChild(labDropdown);
          }
          slotChoiceLine.appendChild(labSelectGroup);
      }
      slotDiv.appendChild(slotChoiceLine);
  }
}

// NEW: Function to filter core slots AND lab slots based on selected faculty (for Java, DSA, CAO, OS)
function filterCoreSlotsAndLabsByFaculty(subjectIndex, choiceIndex, selectedSubject, selectedFaculty) {
    const facultySpecificMapping = subjectFacultySlotLabMapping[selectedSubject];
    const primarySlotSelect = document.getElementById(`slots${subjectIndex}_${choiceIndex}_primary`) || // For paired
                              document.getElementById(`slots${subjectIndex}_${choiceIndex}_0`) ||    // For CVLA
                              document.querySelector(`#slotChoices${subjectIndex} select[name="slots${subjectIndex}_${choiceIndex}"]`); // For generic
    if (!primarySlotSelect) return;

    primarySlotSelect.innerHTML = '<option value="">--Select Primary--</option>'; // Clear existing options

    // Reset secondary/tertiary dropdowns if they exist for paired/trio subjects
    const secondarySlotSelect = document.getElementById(`slots${subjectIndex}_${choiceIndex}_secondary`);
    const tertiarySlotSelect = document.getElementById(`slots${subjectIndex}_${choiceIndex}_2`);
    if (secondarySlotSelect) {
        secondarySlotSelect.innerHTML = '<option value="">--Paired Slot--</option>';
        secondarySlotSelect.disabled = true;
    }
    if (tertiarySlotSelect) {
        tertiarySlotSelect.innerHTML = '<option value="">--Tertiary--</option>';
        tertiarySlotSelect.disabled = true;
    }

    // Reset and disable lab dropdowns
    const labConfig = subjectLabConfig[selectedSubject];
    if (labConfig) {
        for (let k = 0; k < labConfig.numDropdowns; k++) {
            const labDropdown = document.getElementById(`labSlot${subjectIndex}_${choiceIndex}_${k}`);
            if (labDropdown) {
                labDropdown.innerHTML = '<option value="">--Select Lab--</option>';
                labDropdown.disabled = true;
            }
        }
    }


    if (selectedFaculty && facultySpecificMapping && facultySpecificMapping[selectedFaculty]) {
        const coreSlotsForFaculty = Object.keys(facultySpecificMapping[selectedFaculty]);
        coreSlotsForFaculty.forEach(slot => {
            primarySlotSelect.innerHTML += `<option value="${slot}">${slot}</option>`;
        });
        primarySlotSelect.disabled = false; // Enable primary slot dropdown
    } else {
        primarySlotSelect.disabled = true; // Disable if no faculty selected or no slots for faculty
    }
}


// NEW: Function to filter lab slots based on selected core slot and faculty
function filterLabSlotsByCoreSlot(subjectIndex, choiceIndex, selectedSubject, selectedFaculty, selectedCoreSlot) {
    const labConfig = subjectLabConfig[selectedSubject];
    if (!labConfig) return; // Subject has no lab configuration

    const specificLabSlots = subjectFacultySlotLabMapping[selectedSubject]
                             && subjectFacultySlotLabMapping[selectedSubject][selectedFaculty]
                             && subjectFacultySlotLabMapping[selectedSubject][selectedFaculty][selectedCoreSlot];

    for (let k = 0; k < labConfig.numDropdowns; k++) {
        const labDropdown = document.getElementById(`labSlot${subjectIndex}_${choiceIndex}_${k}`);
        if (labDropdown) {
            labDropdown.innerHTML = '<option value="">--Select Lab--</option>'; // Clear existing options
            labDropdown.disabled = true; // Default to disabled

            if (specificLabSlots && specificLabSlots.length > 0) {
                // Populate with specific lab slots
                specificLabSlots.forEach(labPair => {
                    labDropdown.innerHTML += `<option value="${labPair}">${labPair}</option>`;
                });
                labDropdown.disabled = false; // Enable if specific labs found
            } else if (selectedCoreSlot) { // If a core slot is selected but no specific labs are mapped for it/faculty
                // Fallback to all lab pairs if no specific mapping, but a core slot is selected
                allLabPairs.forEach(labPair => {
                    labDropdown.innerHTML += `<option value="${labPair}">${labPair}</option>`;
                });
                labDropdown.disabled = false; // Enable as general labs are available
            }
        }
    }
}


// Function to handle CVLA trio population (C1 -> TC1, TCC1) - triggered by primary slot change
// This is called by the onchange of CVLA's primary slot, after faculty has filtered the primaries.
function populateCVLATrio(subjectIndex, choiceIndex, selectedPrimarySlot) {
    const secondSlotDropdown = document.getElementById(`slots${subjectIndex}_${choiceIndex}_1`);
    const tertiarySlotDropdown = document.getElementById(`slots${subjectIndex}_${choiceIndex}_2`);

    // Clear previous options and reset disabled state
    secondSlotDropdown.innerHTML = `<option value="">--Secondary--</option>`;
    tertiarySlotDropdown.innerHTML = `<option value="">--Tertiary--</option>`;
    secondSlotDropdown.disabled = true;
    tertiarySlotDropdown.disabled = true;

    if (selectedPrimarySlot && cvlaSlotTrios[selectedPrimarySlot]) {
        const [secondary, tertiary] = cvlaSlotTrios[selectedPrimarySlot];
        secondSlotDropdown.innerHTML += `<option value="${secondary}" selected>${secondary}</option>`;
        tertiarySlotDropdown.innerHTML += `<option value="${tertiary}" selected>${tertiary}</option>`;
        secondSlotDropdown.disabled = false;
        tertiarySlotDropdown.disabled = false;
    }
}

// Function for populating paired slots (e.g., A1 -> TA1) - now also triggers lab filtering
// This is called by the onchange of the primary slot for paired subjects.
function populatePairedSlot(subjectIndex, choiceIndex, selectedPrimarySlot, subjectName) {
    const secondarySlotDropdown = document.getElementById(`slots${subjectIndex}_${choiceIndex}_secondary`);
    const { pairings } = subjectPairedSlotInfo[subjectName];

    secondarySlotDropdown.innerHTML = `<option value="">--Paired Slot--</option>`;
    secondarySlotDropdown.disabled = true;

    if (selectedPrimarySlot && pairings[selectedPrimarySlot]) {
        const secondary = pairings[selectedPrimarySlot];
        secondarySlotDropdown.innerHTML += `<option value="${secondary}" selected>${secondary}</option>`;
        secondarySlotDropdown.disabled = false;
    }
    // Lab filtering is now handled by the extended onchange in generateSlotChoices
}


// Inject real timetable generation
function generateTimetables(event) {
  event.preventDefault();
  const formData = new FormData(document.getElementById("ttform"));
  const subjects = [];
  const count = parseInt(document.getElementById("subcount").value);

  for (let i = 0; i < count; i++) {
    const sub = formData.get(`subject${i}`);
    const slotCount = parseInt(document.getElementById(`slotCount${i}`).value); // Get count from input
    let fullSlots = [];
    let teachers = [];

    for (let j = 0; j < slotCount; j++) { // Iterate through each slot choice group
        const faculty = formData.get(`faculty${i}_${j}`); // Faculty for this specific choice group

        // --- Core slot processing (trios, pairs, or single) ---
        if (sub === "CVLA") {
            const primarySlot = formData.get(`slots${i}_${j}_0`);
            const secondarySlot = formData.get(`slots${i}_${j}_1`);
            const tertiarySlot = formData.get(`slots${i}_${j}_2`);

            if (primarySlot && secondarySlot && tertiarySlot && faculty) {
                fullSlots.push(primarySlot, secondarySlot, tertiarySlot);
                teachers.push(faculty, faculty, faculty); // Same faculty for all three slots in the trio
            }
        } else if (subjectPairedSlotInfo[sub]) {
            const primarySlot = formData.get(`slots${i}_${j}_primary`);
            const secondarySlot = formData.get(`slots${i}_${j}_secondary`);

            if (primarySlot && faculty) {
                fullSlots.push(primarySlot);
                teachers.push(faculty);
                if (secondarySlot && secondarySlot !== "--Paired Slot--") {
                    fullSlots.push(secondarySlot);
                    teachers.push(faculty);
                }
            }
        } else {
            fullSlots.push(formData.get(`slots${i}_${j}`));
            teachers.push(faculty);
        }

        // --- Lab slot processing (inline for each slot choice) ---
        if (subjectLabConfig[sub]) {
            const labConfig = subjectLabConfig[sub];
            for (let k = 0; k < labConfig.numDropdowns; k++) {
                const selectedLabPair = formData.get(`labSlot${i}_${j}_${k}`); // Unique name for lab slot
                if (selectedLabPair) {
                    const [slot1, slot2] = selectedLabPair.split("+");
                    fullSlots.push(slot1, slot2);
                    // Lab teachers are specific to this choice group
                    teachers.push(`${sub} Lab Teacher (${faculty})`, `${sub} Lab Teacher (${faculty})`);
                }
            }
        }
    }
    subjects.push({ name: sub, slots: fullSlots, teachers });
  }

  const used = {};
  const allTimetables = [];

  function isClash(slots) {
    return slots.some(s => used[s]);
  }
  function assign(slots, subject, teacher) {
    slots.forEach((s, idx) => used[s] = `${subject} (${teacher[idx] || teacher[0]})`);
  }
  function unassign(slots) {
    slots.forEach(s => delete used[s]);
  }
  function backtrack(idx) {
    if (idx === subjects.length) return true;
    const s = subjects[idx];
    if (!isClash(s.slots)) {
      assign(s.slots, s.name, s.teachers);
      if (backtrack(idx + 1)) return true;
      unassign(s.slots);
    }
    return false;
  }

  let countTT = 0;
  for (let tries = 0; tries < 20 && countTT < 5; tries++) {
    Object.keys(used).forEach(k => delete used[k]);
    if (backtrack(0)) {
      allTimetables.push(JSON.parse(JSON.stringify(used)));
      countTT++;
    }
  }

  const out = document.getElementById("output");
  const visual = document.getElementById("visualOutput");
  out.innerHTML = `<h2>Generated ${countTT} Timetables</h2>`;
  visual.innerHTML = '';

  const times = ["8:00 AM", "8:55 AM", "9:50 AM", "10:45 AM", "11:40 AM", "12:35 PM", "2:00 PM", "2:55 PM", "3:50 PM"];
  const days = ["MON","TUE","WED","THU","FRI"];
  const slotsMatrix = [
    ["A1","F1","D1","TB1","TG1","S11","A2","F2","D2"],
    ["B1","G1","E1","TC1","TAA1","L12","B2","G2","E2"],
    ["C1","A1","F1","TD1","TBB1","L18","C2","A2","F2"],
    ["D1","B1","G1","TE1","TCC1","L24","D2","B2","G2"],
    ["E1","C1","TA1","TF1","TDD1","S15","E2","C2","TA2"]
  ];

  allTimetables.forEach((tt, idx) => {
    let grid = `<h3>Timetable ${idx + 1}</h3><div class='grid-timetable'>`;
    grid += `<div class='grid-cell row-head'></div>` + times.map(t => `<div class='grid-cell header'>${t}</div>`).join('');
    days.forEach((day, r) => {
      grid += `<div class='grid-cell row-head'>${day}</div>`;
      for (let c = 0; c < 9; c++) {
        const slot = slotsMatrix[r][c];
        grid += `<div class='grid-cell'>${tt[slot] || '-'}</div>`;
      }
    });
    grid += `</div>`;
    visual.innerHTML += grid;
  });
}

document.getElementById("ttform").addEventListener("submit", generateTimetables);
</script>

</body>
</html>
